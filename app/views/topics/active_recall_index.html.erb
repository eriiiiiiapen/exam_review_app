<div class="w-full px-4 py-8">
  <h1 class="text-2xl font-bold mb-8 border-b-2 border-gray-100 pb-4 text-gray-700">今日の復習論点</h1>

  <div id="recommended-topics-list" class="grid grid-cols-1 md:grid-cols-3 gap-8">
    <% @recommended_topics.each do |topic| %>
      <% study_log = topic.study_logs.find { |l| l.user_id == current_user.id } || topic.study_logs.build(user: current_user) %>

      <div class="bg-white border-2 border-gray-200 rounded-2xl p-6 shadow-sm flex flex-col min-h-[400px]" id="<%= dom_id(topic, :recall) %>">
        <%= form_with(model: study_log, url: create_or_update_topic_study_log_path(topic), method: :patch, id: "form_#{dom_id(topic)}", class: "flex flex-col h-full") do |f| %>
          <div class="mb-4">
            <span class="inline-block bg-blue-50 text-blue-600 text-xs px-2 py-1 rounded-md font-bold mb-2">
              <%= topic.subject.name %>
            </span>
            <h3 class="text-xl font-bold text-gray-800 leading-snug line-clamp-2" title="<%= topic.name %>">
              <%= topic.name %>
            </h3>
          </div>

          <div class="flex-grow mb-6">
            <%= f.text_area :note, 
                  rows: 5, 
                  class: "w-full text-base border-2 border-blue-50 rounded-xl focus:border-blue-400 p-4 bg-gray-50/50 transition-colors", 
                  placeholder: "覚えている内容をここにアウトプット...",
                  data: { action: "input->active-recall#toggleButton" } %>
          </div>

          <div class="mt-auto">
            <details class="group border-t border-gray-100 pt-4">
              <summary class="list-none cursor-pointer">
                <div class="w-full py-3 text-center bg-gray-900 text-white rounded-xl font-bold hover:bg-black transition-all shadow-md">
                   答え合わせをする
                </div>
              </summary>

              <div class="mt-4 animate-in slide-in-from-bottom-2 duration-300">
                <div class="p-4 bg-green-50 rounded-xl border border-green-100 max-h-48 overflow-y-auto mb-6">
                  <h4 class="text-[10px] font-black text-green-700 mb-1 uppercase tracking-widest">Correct Answer</h4>
                  <p class="text-gray-800 leading-relaxed text-sm"><%= topic.description %></p>
                </div>

                <div class="space-y-4">
                  <p class="text-center text-xs font-bold text-gray-500">理解度はどうでしたか？</p>
                  <div class="grid grid-cols-2 gap-3">
                    <% StudyLog.understanding_levels.keys.each do |level| %>
                      <label class="cursor-pointer group/label">
                        <%= f.radio_button :understanding_level, level, class: "peer hidden", id: "radio_#{topic.id}_#{level}" %>
                        <div class="py-3 text-xs text-center border-2 rounded-xl font-bold transition-all
                                    peer-checked:bg-blue-600 peer-checked:text-white peer-checked:border-blue-600
                                    border-gray-100 bg-white text-gray-400 group-hover/label:border-blue-100">
                          <%= I18n.t("activerecord.attributes.study_log.understanding_levels.#{level}") %>
                        </div>
                      </label>
                    <% end %>
                  </div>
                  
                  <%= f.submit "学習完了", class: "w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition-all mt-2" %>
                </div>
              </div>
            </details>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>